<% if (paymentMode === 'modal') { %>
<!-- Payment Options Modal -->
<div
  id="paymentModal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    backdrop-filter: blur(3px);
  "
>
  <div
    style="
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 40px;
      border-radius: 20px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 2px solid #e04a25;
    "
  >
    <div style="text-align: center; margin-bottom: 30px">
      <div
        style="
          width: 60px;
          height: 60px;
          background: #e04a25;
          border-radius: 50%;
          margin: 0 auto 15px;
          display: flex;
          align-items: center;
          justify-content: center;
        "
      >
        <span style="color: white; font-size: 24px; font-weight: bold">ðŸ’³</span>
      </div>
      <h3 style="margin: 0; color: #333; font-size: 22px; font-weight: 600">
        Selecciona una opciÃ³n de pago
      </h3>
      <p style="margin: 10px 0 0; color: #666; font-size: 14px">
        Elige tu mÃ©todo de pago preferido
      </p>
      <p style="margin: 10px 0 0; color: #888; font-size: 12px">
        Â¿No sabes quÃ© es CoDi?
        <a
          href="/guia-codi"
          target="_blank"
          style="color: #e04a25; text-decoration: none"
          >Consulta nuestra guÃ­a aquÃ­</a
        >
      </p>
    </div>
    <div style="display: flex; flex-direction: column; gap: 12px">
      <button
        onclick="redirectToPayment('codi')"
        style="
          padding: 18px 20px;
          background: linear-gradient(135deg, #e04a25, #d63916);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 6px;
          box-shadow: 0 4px 15px rgba(224, 74, 37, 0.3);
        "
        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(224,74,37,0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(224,74,37,0.3)'"
      >
        <div style="display: flex; align-items: center; gap: 10px">
          <span style="font-size: 20px">ðŸ“±</span>
          <span>Pagar con CoDi</span>
        </div>
        <span style="font-size: 13px; font-weight: 400; opacity: 0.95">
          Paga en un toque Â¡RÃ¡pido, fÃ¡cil y seguro!
        </span>
      </button>

      <button
        onclick="redirectToPayment('tarjeta')"
        style="
          padding: 18px 20px;
          background: linear-gradient(135deg, #e04a25, #d63916);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          box-shadow: 0 4px 15px rgba(224, 74, 37, 0.3);
        "
        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(224,74,37,0.4)'"
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(224,74,37,0.3)'"
      >
        <span style="font-size: 20px">ðŸ’³</span>
        Tarjeta de CrÃ©dito/DÃ©bito
      </button>
      <button
        onclick="closePaymentModal()"
        style="
          padding: 12px 20px;
          background: transparent;
          color: #666;
          border: 2px solid #ddd;
          border-radius: 12px;
          font-size: 14px;
          font-weight: 500;
          cursor: pointer;
          margin-top: 15px;
          transition: all 0.3s ease;
        "
        onmouseover="this.style.borderColor='#bbb'; this.style.color='#333'"
        onmouseout="this.style.borderColor='#ddd'; this.style.color='#666'"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>
<% } %>

<!-- Payment JavaScript -->
<script>
  // Unified payment handler that checks environment configuration
  function handlePayment() {
    <% if (paymentMode === 'modal') { %>
      // Modal mode: show payment options
      showPaymentOptions();
    <% } else { %>
      // Simple mode: direct redirect
      window.location.href = 'https://admin.salsa-candela.com/fiesta/boletos';
    <% } %>
  }

  <% if (paymentMode === 'modal') { %>
  // Modal payment functions (only loaded when needed)
  function showPaymentOptions() {
    document.getElementById("paymentModal").style.display = "block";
  }

  function closePaymentModal() {
    document.getElementById("paymentModal").style.display = "none";
  }

  function redirectToPayment(paymentType) {
    const referralCode = "<%= typeof referralCode !== 'undefined' ? referralCode : '' %>";

    // Track payment intent in Google Analytics
    if (typeof gtag !== 'undefined') {
      gtag('event', 'payment_method_selected', {
        'event_category': 'Party Ticket Purchase',
        'event_label': paymentType === 'codi' ? 'Party - CoDi' : 'Party - Tarjeta',
        'language': '<%= lang %>',
        'payment_method': paymentType,
        'purchase_type': 'party_ticket',
        'has_referral_code': referralCode ? 'yes' : 'no'
      });
    }

    if (paymentType === "codi") {
      const codiUrl = referralCode
        ? `https://admin.salsa-candela.com/fiesta/boletos/codi/push/${referralCode}`
        : "https://admin.salsa-candela.com/fiesta/boletos/codi/push";
      window.location.href = codiUrl;
    } else if (paymentType === "tarjeta") {
      const stripeUrl = referralCode
        ? `https://admin.salsa-candela.com/fiesta/boletos/${referralCode}`
        : "https://admin.salsa-candela.com/fiesta/boletos";
      window.location.href = stripeUrl;
    }
  }

  // Close modal when clicking outside
  document
    .getElementById("paymentModal")
    .addEventListener("click", function (e) {
      if (e.target === this) {
        closePaymentModal();
      }
    });
  <% } %>
</script>
